
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// СтандартныеПодсистемы.ПодключаемыеКоманды
	ПодключаемыеКоманды.ПриСозданииНаСервере(ЭтотОбъект);
	// Конец СтандартныеПодсистемы.ПодключаемыеКоманды
	
	//{{Прозорова П.: Добавление контактного лица на форму
	ПолеКонтактныеЛица = Элементы.Добавить("КонтактноеЛицо", Тип("ПолеФормы"), Элементы.ГруппаШапкаПраво);
	ПолеКонтактныеЛица.Вид = ВидПоляФормы.ПолеВвода;
	ПолеКонтактныеЛица.ПутьКДанным = "Объект.Изм_КонтактноеЛицо";
	
	//Добавление согласованной скидки
	ГруппаСкидка = ЭтаФорма.Элементы.Вставить("ГруппаСкидка", Тип("ГруппаФормы"),, Элементы.Страницы);
	ГруппаСкидка.Вид = ВидГруппыФормы.ОбычнаяГруппа;
 
	ГруппаСкидка.Группировка = ГруппировкаПодчиненныхЭлементовФормы.ГоризонтальнаяВсегда; 
	
	ПолеСогласованнаяСкидка = Элементы.Добавить("СогласованнаяСкидка", Тип("ПолеФормы"), ГруппаСкидка);
	ПолеСогласованнаяСкидка.Вид = ВидПоляФормы.ПолеВвода;
	ПолеСогласованнаяСкидка.ПутьКДанным = "Объект.Изм_СогласованнаяСкидка";    
	ПолеСогласованнаяСкидка.УстановитьДействие("ПриИзменении", "СогласованнаяСкидкаПриИзменении");
	
	КомандаПересчитатьСумму = Команды.Добавить("ПересчитатьСумму");
	КомандаПересчитатьСумму.Заголовок = "Пересчитать Сумму";
	КомандаПересчитатьСумму.Действие = "ПересчитатьСуммуНажатие"; //указываем только имя процедуры  
	
	КнопкаПересчитатьСумму = Элементы.Добавить("КнопкаПересчитатьСумму", Тип("КнопкаФормы"), ГруппаСкидка);
	КнопкаПересчитатьСумму.вид = ВидКнопкиФормы.ОбычнаяКнопка;
	КнопкаПересчитатьСумму.ИмяКоманды = "ПересчитатьСумму";
	//Прозорова П.}}
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
    // СтандартныеПодсистемы.ПодключаемыеКоманды
    ПодключаемыеКомандыКлиент.НачатьОбновлениеКоманд(ЭтотОбъект);
    // Конец СтандартныеПодсистемы.ПодключаемыеКоманды
	
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	
    // СтандартныеПодсистемы.ПодключаемыеКоманды
    ПодключаемыеКомандыКлиентСервер.ОбновитьКоманды(ЭтотОбъект, Объект);
    // Конец СтандартныеПодсистемы.ПодключаемыеКоманды
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
    ПодключаемыеКомандыКлиент.ПослеЗаписи(ЭтотОбъект, Объект, ПараметрыЗаписи);
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыТовары

&НаКлиенте
Процедура ТоварыКоличествоПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	
	РассчитатьСуммуСтроки(ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыЦенаПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	
	РассчитатьСуммуСтроки(ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСкидкаПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	
	РассчитатьСуммуСтроки(ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыПриИзменении(Элемент)
	
	РассчитатьСуммуДокумента();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыУслуги

&НаКлиенте
Процедура УслугиКоличествоПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Услуги.ТекущиеДанные;
	
	РассчитатьСуммуСтроки(ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура УслугиЦенаПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Услуги.ТекущиеДанные;
	
	РассчитатьСуммуСтроки(ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура УслугиСкидкаПриИзменении(Элемент)
		
	ТекущиеДанные = Элементы.Услуги.ТекущиеДанные;
	
	РассчитатьСуммуСтроки(ТекущиеДанные);

КонецПроцедуры

&НаКлиенте
Процедура УслугиПриИзменении(Элемент)
	
	РассчитатьСуммуДокумента();

КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура РассчитатьСуммуСтроки(ТекущиеДанные)
	//{{Прозорова П.: Именениее подсчета суммы строки
	
	//ТекущиеДанные.Сумма = ТекущиеДанные.Цена * ТекущиеДанные.Количество;
	ТекущиеДанные.Сумма = ТекущиеДанные.Цена * ТекущиеДанные.Количество * (100 - Объект.Изм_СогласованнаяСкидка) / 100;	
	РассчитатьСуммуДокумента();
	
	//Прозорова П.}}
	
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьСуммуДокумента()
	
	Объект.СуммаДокумента = Объект.Товары.Итог("Сумма") + Объект.Услуги.Итог("Сумма");
	
КонецПроцедуры

#Область ПодключаемыеКоманды

// СтандартныеПодсистемы.ПодключаемыеКоманды
&НаКлиенте
Процедура Подключаемый_ВыполнитьКоманду(Команда)
    ПодключаемыеКомандыКлиент.НачатьВыполнениеКоманды(ЭтотОбъект, Команда, Объект);
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ПродолжитьВыполнениеКомандыНаСервере(ПараметрыВыполнения, ДополнительныеПараметры) Экспорт
    ВыполнитьКомандуНаСервере(ПараметрыВыполнения);
КонецПроцедуры

&НаСервере
Процедура ВыполнитьКомандуНаСервере(ПараметрыВыполнения)
    ПодключаемыеКоманды.ВыполнитьКоманду(ЭтотОбъект, ПараметрыВыполнения, Объект);
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ОбновитьКоманды()
    ПодключаемыеКомандыКлиентСервер.ОбновитьКоманды(ЭтотОбъект, Объект);
КонецПроцедуры
// Конец СтандартныеПодсистемы.ПодключаемыеКоманды


//{{Прозорова П.: Обработка нажатия кнопки "Пересчитать сумму" 

&НаКлиенте         
Процедура ПересчитатьСуммуНажатие(Команда)
	ПересчитатьСумму();	
КОнецПроцедуры
//Прозорова П.}}

#КонецОбласти


//{{Прозорова П.: Пересчет суммы 

&НаКлиенте         
ПРоцедура ПересчитатьСумму()
	Для каждого СтрокаТовар из Объект.Товары цикл
		СтрокаТовар.Сумма = СтрокаТовар.Цена * СтрокаТовар.Количество * (100 - Объект.Изм_СогласованнаяСкидка) / 100;
	КонецЦикла;    
	Для каждого СтрокаУслуга из Объект.Услуги цикл
		СтрокаУслуга.Сумма = СтрокаУслуга.Цена * СтрокаУслуга.Количество * (100 - Объект.Изм_СогласованнаяСкидка) / 100;
	КонецЦикла; 
	РассчитатьСуммуДокумента();	
КОнецПроцедуры
//Прозорова П.}}          


//{{Прозорова П.: Обработка события при изменении согласованной скидки 

&НаКлиенте
Процедура СогласованнаяСкидкаПриИзменении(Элемент) 
	Если Объект.Товары.Количество() <> 0 тогда  
		Оповещение = Новый ОписаниеОповещения("ПослеЗакрытияВопроса",ЭтотОбъект);     
    	ПоказатьВопрос(Оповещение,"Пересчитать сумму?",РежимДиалогаВопрос.ДаНет,0,КодВозвратаДиалога.Да, "Скидка изменена");     
	КонецЕсли;
КонецПроцедуры  
 
&НаКлиенте
Процедура ПослеЗакрытияВопроса(Результат, Параметры) Экспорт
 
    Если Результат = КодВозвратаДиалога.Да Тогда
        ПересчитатьСумму();
    КонецЕсли;    
 
КонецПроцедуры   

//Прозорова П.}}   

#КонецОбласти
